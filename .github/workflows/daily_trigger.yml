name: Daily Stock Analysis Batch

on:
  schedule:
    # JST 07:00 (UTC 23:00) に実行
    - cron: "0 22 * * *"
  workflow_dispatch:
    inputs:
      date:
        description: "Execution Date (YYYY-MM-DD)"
        required: false
        default: ""

jobs:
  run-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 60 # 【変更】AI分析で時間がかかるため60分に延長

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Daily Analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            python batch_jobs/daily_analysis_all.py --date "${{ github.event.inputs.date }}"
          else
            python batch_jobs/daily_analysis_all.py
          fi

      # --- 【追加】ここからDiscord通知設定 ---
      - name: Notify Discord
        uses: sarisia/actions-status-discord@v1
        if: always() # 成功しても失敗しても必ず実行
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "Daily Stock Analysis Batch"
          # 成功なら緑、失敗なら赤になります
          status: ${{ job.status }}
          nofail: false
          description: |
            バッチ処理が終了しました。
            詳細はGithub Actionsのログ、またはアプリを確認してください。
